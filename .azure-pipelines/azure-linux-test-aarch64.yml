stages:
- stage: azure_linux_test_aarch
  displayName: 'aarch64'

  jobs:
  - job: 'arm64'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self
      submodules: true
      clean: true

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.7'
        architecture: 'arm64'

    - script: |
        sudo apt-get install qemu
        sudo apt-get install qemu-user
        sudo apt-get install qemu-user-static
        sudo apt-get install qemu-system-arm
      displayName: 'Installing qemu libraries'
    - script: docker run --rm --privileged hypriot/qemu-register
      displayName: 'Regietering qemu'
    - script: |
        export DOCKER_IMAGE=condaforge/linux-anvil-aarch64
        bash buildscripts/incremental/run_docker_build.sh
      displayName: 'Running AArch64 build'
